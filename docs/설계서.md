# devops-assist 설계서

> 버전: 0.2 | 작성일: 2026-02-27 | 상태: 초안

---

## 1. 프로젝트 개요

**devops-assist**는 계정 기반 개인 지식 관리 웹 서비스다.
사용자는 블록 기반 리치 텍스트 에디터로 문서를 작성하고,
AI가 관련 문서를 추천하거나 요약·보완 제안을 제공한다.

### 목표

- **개인 생산성**: 내가 먼저 써보며 검증
- **포트폴리오**: AI 기반 지식 관리 서비스 구현 경험
- **단계 확장**: A(문서) → B(프로젝트 연결) → C(통합)

---

## 2. 핵심 사용 시나리오

### 시나리오 1: 문서 작성 + 자동 저장
```
사용자 로그인
→ 새 문서 생성
→ 블록 에디터에서 내용 입력 (slash command로 블록 추가)
→ 태그 입력
→ 3초 후 자동 저장
```

### 시나리오 2: AI 관련 문서 추천
```
문서 A 열람 중
→ 사이드바에 "관련 문서" 패널 자동 로드
→ Gemini가 문서 A 내용 분석 → 유사 문서 B, C, D 추천
→ 추천 문서 클릭 → 해당 문서로 이동
```

### 시나리오 3: AI 요약 및 보완 제안
```
문서 작성 완료
→ "요약" 버튼 클릭 → SSE 스트리밍으로 요약 출력
→ "보완 제안" 버튼 클릭 → Gemini가 부족한 부분 제안
→ 제안 내용을 문서에 삽입 버튼으로 추가
```

### 시나리오 4: 문서 구조 관리
```
왼쪽 사이드바: 폴더 트리 표시
→ 폴더 생성/이름 변경/삭제
→ 문서 드래그로 폴더 간 이동
→ 태그 필터 클릭 → 해당 태그 문서만 표시
```

---

## 3. UI 레이아웃

```
┌──────────────────────────────────────────────────────────────┐
│  devops-assist             [검색창]         [사용자명 ▼]      │  ← 헤더
├─────────────────┬────────────────────────┬───────────────────┤
│  📁 폴더 트리   │                        │  AI 패널          │
│                 │   문서 에디터           │                   │
│  - 폴더 A       │                        │  [관련 문서]       │
│    - 문서 1     │   제목: Spring 정리_   │  - 문서 B         │
│    - 문서 2     │         ↑ Tab수락      │  - 문서 C         │
│  - 폴더 B       │   / 블록 에디터        │  - 문서 D         │
│    - 문서 3     │   내용 입력 영역       │                   │
│                 │                        │  [요약] [제안]    │
│  🏷 태그        │   태그: [spring]       │                   │
│  #spring        │          jwt Tab↵      │  AI 응답 스트리밍 │
│  #java          │          ↑ 고스트 제안 │  출력 영역        │
│  #정리          │   저장됨 ✓  수정일시  │                   │
└─────────────────┴────────────────────────┴───────────────────┘
```

**인라인 제안 UX 상세:**
- 태그/제목/폴더명 입력창에 포커스 시 고스트 텍스트(회색)로 AI 제안 표시
- `Tab` → 제안 수락, `Esc` → 제안 해제, 타이핑 시작 → 제안 갱신
- 태그는 Tab 연타로 여러 개 연속 추가 가능

---

## 4. 인증 흐름

```
회원가입: email + password + username
  → bcrypt 해싱 저장
  → 가입 완료

로그인: email + password
  → 검증
  → Access Token (15분) + Refresh Token (7일) 발급
  → Access Token: Authorization 헤더
  → Refresh Token: HttpOnly 쿠키

요청마다: Authorization: Bearer {accessToken}
  → JwtAuthFilter에서 검증
  → 만료 시 /api/auth/refresh 호출 → 재발급

로그아웃: Refresh Token DB에서 삭제
```

---

## 5. AI 서비스 설계

> AI는 보조 역할. 인라인 제안(즉각 응답)과 온디맨드(버튼 클릭) 두 가지로 동작한다.

### GeminiService (dev-agent 패턴 재사용)

```java
// 인라인 제안 (즉각 응답, 500ms 이내 목표)
InlineSuggestion suggestTitle(String content);
InlineSuggestion suggestTags(String content, List<String> existingTags);
InlineSuggestion suggestFolderName(String documentTitle, String content);

// 온디맨드 — 스트리밍 (SSE)
Flux<String> streamSummary(String documentContent);
Flux<String> streamSuggestion(String documentContent);

// 온디맨드 — 일반 응답 (JSON)
List<RelatedDocResult> findRelatedDocs(String content, List<Document> workspace);
```

### 인라인 제안 로직

```
사용자가 입력창에 포커스
→ 현재 문서 content + title을 컨텍스트로 Gemini 호출
→ 응답 도착 시 고스트 텍스트로 표시
→ Tab: 수락 / Esc: 해제 / 타이핑: 제안 갱신

태그 제안: 3~5개 후보 반환 → Tab으로 하나씩 수락
제목 제안: 1개 반환 → Tab으로 전체 수락
폴더명 제안: 1개 반환 → Tab으로 전체 수락
```

### 관련 문서 추천 로직

```
현재 문서 내용 → Gemini에 키워드 추출 요청
→ 워크스페이스 전체 문서 제목 + 태그 목록과 비교
→ 유사도 계산 (키워드 겹침 + 태그 교집합)
→ 상위 5개 반환
```

---

## 6. 자동 저장 설계

```
에디터 변경 감지 (Tiptap onChange)
→ 3초 debounce
→ PUT /api/documents/{id} 호출
→ 응답 성공 시 "저장됨 ✓" 표시
→ 실패 시 "저장 실패 — 재시도 중..." 표시 + retry
```

---

## 7. 개발 우선순위 (Phase A)

### Sprint 1 — 기반
- [ ] Spring Boot 프로젝트 세팅 (포트 8080, MySQL 연결)
- [ ] JWT 인증 (회원가입, 로그인, 재발급, 로그아웃)
- [ ] Document CRUD API
- [ ] Folder CRUD API
- [ ] Tag API

### Sprint 2 — 에디터
- [ ] React + Vite 프론트 세팅
- [ ] Tiptap 블록 에디터 구현
- [ ] 폴더 트리 사이드바
- [ ] 자동 저장 연동

### Sprint 3 — AI
- [ ] GeminiService 통합
- [ ] 관련 문서 추천
- [ ] 요약 / 보완 제안 (SSE 스트리밍)

### Sprint 4 — 마무리
- [ ] 태그 자동 제안 (AI)
- [ ] 자연어 검색
- [ ] 배포 (단일 JAR)
- [ ] 본인 테스트

---

## 8. 에러 처리 설계

### 공통 에러 응답 형식

```json
{
  "timestamp": "2026-02-27T10:30:00Z",
  "status": 401,
  "error": "UNAUTHORIZED",
  "code": "AUTH_TOKEN_EXPIRED",
  "message": "액세스 토큰이 만료되었습니다.",
  "path": "/api/documents"
}
```

### HTTP 상태코드 정책

| 코드 | 사용 상황 |
|------|-----------|
| 200 | 조회, 수정 성공 |
| 201 | 생성 성공 |
| 204 | 삭제, 로그아웃 |
| 400 | 입력값 유효성 오류 |
| 401 | 토큰 없음/만료/무효 |
| 403 | 타인 리소스 접근 |
| 404 | 리소스 없음 |
| 409 | 중복 (이메일, 태그명 등) |
| 500 | 서버 내부 오류 |
| 503 | Gemini API 응답 불가 |

### 도메인별 에러 코드

| 접두사 | 범위 |
|--------|------|
| `AUTH_` | 인증/인가 |
| `DOC_` | 문서 |
| `FOLD_` | 폴더 |
| `TAG_` | 태그 |
| `AI_` | AI 서비스 |

### Spring Boot 구현 방향

```
@RestControllerAdvice — GlobalExceptionHandler
  → DevopsAssistException (base) 상속 계층
  → AuthException / DocumentException / FolderException / AiException
  → 각 예외가 code, message, status 포함
```

### 프론트엔드 에러 처리

| 상황 | 처리 방식 |
|------|-----------|
| 401 AUTH_TOKEN_EXPIRED | Axios 인터셉터에서 자동 refresh 후 원래 요청 재시도 |
| 401 AUTH_REFRESH_TOKEN_INVALID | 로그인 페이지로 리다이렉트 |
| 403 | "접근 권한이 없습니다" 토스트 |
| 503 AI_SERVICE_UNAVAILABLE | "AI 서비스에 일시적인 오류가 발생했습니다" 토스트 |
| SSE 에러 | `data: {"error": ...}` 수신 시 에러 메시지 표시 후 스트림 종료 |

---

## 9. 보안 설계

### CORS 설정

```
개발: allowedOrigins = http://localhost:5173
배포: allowedOrigins = http://{host}
allowedMethods: GET, POST, PUT, PATCH, DELETE, OPTIONS
allowCredentials: true  (쿠키 전송 위해 필수)
```

### 입력 유효성 검증 (Bean Validation)

| 필드 | 규칙 |
|------|------|
| email | @Email, 최대 255자 |
| password | 8~72자, 영문+숫자 필수 포함 |
| username | 2~50자 |
| 폴더명 | 1~100자, 특수문자 `/\` 불가 |
| 태그명 | 1~50자, 공백 불가 |
| 문서 제목 | 최대 500자 |

### XSS 방지

- 에디터 저장 형식: **Tiptap JSON** (raw HTML 저장 안 함)
- JSON 구조로 저장되므로 `<script>` 삽입 불가
- 렌더링은 Tiptap이 JSON → HTML 변환 (자체 XSS 방어 내장)

### JWT 보안

| 항목 | 내용 |
|------|------|
| Access Token 저장 | 클라이언트 메모리 (localStorage X) |
| Access Token 유효기간 | 15분 |
| Refresh Token 저장 | HttpOnly; Secure; SameSite=Strict 쿠키 |
| Refresh Token 유효기간 | 7일 |
| Refresh Token Rotation | 사용 시마다 신규 발급, 이전 토큰 즉시 무효화 |
| 서명 알고리즘 | HS256 |
| Secret Key | application.properties (환경변수로 주입) |

### API 접근 제어 3단계

```
1단계 — 공개 (인증 불필요)
  POST /api/auth/signup
  POST /api/auth/login
  POST /api/auth/refresh

2단계 — 인증 필요 (JWT 검증)
  그 외 모든 API

3단계 — 소유권 검증 (서비스 레이어)
  문서/폴더/태그 조회·수정·삭제 시
  → 해당 리소스의 workspace_id가 현재 사용자 것인지 확인
  → 불일치 시 403 DOC_ACCESS_DENIED / FOLD_ACCESS_DENIED
```

---

## 10. Phase A 결정 사항

초안에서 미결이었던 항목을 다음과 같이 확정한다:

| 항목 | 결정 | 비고 |
|------|------|------|
| DB 호스팅 | 로컬 MySQL | 개발 및 본인 테스트 단계 |
| 배포 환경 | 포트포워딩 | 외부 테스터 제공 시 |
| 이미지 첨부 | Phase A 미포함 | Phase B에서 검토 |
| 다국어 | 한국어 전용 | Phase A 범위 |
